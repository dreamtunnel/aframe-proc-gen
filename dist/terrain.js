"use strict";(()=>{var q=.5*(Math.sqrt(3)-1),R=(3-Math.sqrt(3))/6,P=1/3,X=1/6,W=(Math.sqrt(5)-1)/4,Y=(5-Math.sqrt(5))/20,C=t=>Math.floor(t)|0,S=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function v(t=Math.random){let o=N(t),n=new Float64Array(o).map(c=>S[c%12*2]),e=new Float64Array(o).map(c=>S[c%12*2+1]);return function(s,u){let r=0,y=0,i=0,g=(s+u)*q,A=C(s+g),E=C(u+g),T=(A+E)*R,h=A-T,M=E-T,l=s-h,f=u-M,w,b;l>f?(w=1,b=0):(w=0,b=1);let F=l-w+R,x=f-b+R,m=l-1+2*R,a=f-1+2*R,j=A&255,k=E&255,d=.5-l*l-f*f;if(d>=0){let p=j+o[k],G=n[p],D=e[p];d*=d,r=d*d*(G*l+D*f)}let z=.5-F*F-x*x;if(z>=0){let p=j+w+o[k+b],G=n[p],D=e[p];z*=z,y=z*z*(G*F+D*x)}let H=.5-m*m-a*a;if(H>=0){let p=j+1+o[k+1],G=n[p],D=e[p];H*=H,i=H*H*(G*m+D*a)}return 70*(r+y+i)}}function N(t){let n=new Uint8Array(512);for(let e=0;e<512/2;e++)n[e]=e;for(let e=0;e<512/2-1;e++){let c=e+~~(t()*(256-e)),s=n[e];n[e]=n[c],n[c]=s}for(let e=256;e<512;e++)n[e]=n[e-256];return n}AFRAME.registerComponent("terrain",{schema:{width:{type:"number",default:100},height:{type:"number",default:100},flatRadius:{type:"number",default:10},smoothness:{type:"number",default:1},minHeight:{type:"number",default:-10},maxHeight:{type:"number",default:10},avgHeight:{type:"number",default:0},distanceScale:{type:"number",default:1},colors:{type:"array",default:["#000000","#4e3f30","#686256","#7e837f","#a8a9ad"]}},map:function(t,o,n,e,c){let s=(t-o)/(n-o);return(c-e)*s+e},noise:function(t,o){return this.noise2D(t,o)/2+.5},octave:function(t,o,n,e){let c=0,s=1/e,u=0,r=1;for(let y=0;y<n;y++)c+=this.noise(t*s,o*s)*r,u+=r,r/=2,s*=2;return c/u},generateMesh:function(){let{width:t,height:o,avgHeight:n,minHeight:e,maxHeight:c,flatRadius:s,smoothness:u,colors:r,distanceScale:y}=this.data,i=new THREE.PlaneGeometry(t,o,t-1,o-1);i.receiveShadow=!0,i.castShadow=!0,console.log(i);let g=i.attributes.position.array,A=new Float32Array(i.attributes.position.count*3),E=s*2;for(let h=0,M=0;h<g.length;h+=3,M+=1){let l=M%t/t,f=Math.floor(M/t)/o,w=l-.5,b=f-.5,F=Math.sqrt(w*w+b*b),x=F*t;if(x<=s)g[h+2]=0;else{let j=this.octave(l,f,16,u),k=x<=s+E?(x-s)/E:1,d=c-e;g[h+2]=Math.min(Math.max(this.map(j,0,1,n-d,n+d)*k*F**y,e),c)}let m=g[h+2],a;m<-.1?a=new THREE.Color(r[0]):m<2?a=new THREE.Color(r[1]):m<5?a=new THREE.Color(r[2]):m<20?a=new THREE.Color(r[3]):a=new THREE.Color(r[4]),a.toArray(A,h)}i.setAttribute("color",new THREE.BufferAttribute(A,3)),i.rotateX(-Math.PI/2),i.computeVertexNormals();let T=new THREE.MeshPhongMaterial({vertexColors:!0});return new THREE.Mesh(i,T)},addWater:function(){let t=document.createElement("a-plane");t.setAttribute("position","0 -0.1 0"),t.setAttribute("rotation","-90 0 0"),t.setAttribute("width",this.data.width),t.setAttribute("height",this.data.height),t.setAttribute("color","#44ccff"),t.setAttribute("opacity","0.8"),this.el.appendChild(t)},init:function(){this.noise2D=v();let t=this.generateMesh();this.addWater(),this.el.setObject3D("mesh",t)}});})();
